from pyspark.sql.functions import expr, lit
from pyspark.sql import DataFrame

# Columns used for matching
matching_columns = [
    "dr_acct_num", "cr_acct_num",
    "dr_fin_inst", "cr_fin_inst",
    "dr_lob", "cr_lob",
    "dr_acct_nm", "cr_acct_nm",
    "tentr", "ncorg", "tdisc"
]

# Load rules to driver (1300 rules is safe)
rules = like_rules_df.collect()

matched_df = None

# Loop over each rule
for rule in rules:
    conditions = []

    for colname in matching_columns:
        val = rule[colname]
        
        if val is None:
            continue  # Skip nulls â€” match anything
        
        elif '%' in val:
            # Respect wildcard position
            regex = val.replace('%', '.*')
            if not val.startswith('%'):
                regex = '^' + regex
            if not val.endswith('%'):
                regex = regex + '$'
            conditions.append(f"{colname} RLIKE '{regex}'")
        
        else:
            # Exact match
            conditions.append(f"{colname} = '{val}'")
    
    # Skip rule if no matching conditions (all columns null)
    if not conditions:
        continue

    condition_expr = " AND ".join(conditions)

    matched = transactions_df.filter(expr(condition_expr)) \
        .withColumn("rule_id", lit(rule['rule_id'])) \
        .withColumn("purpose_lvl1", lit(rule['purpose_lvl1'])) \
        .withColumn("purpose_lvl2", lit(rule['purpose_lvl2'])) \
        .withColumn("purpose_lvl3", lit(rule['purpose_lvl3'])) \
        .withColumn("purpose_lvl4", lit(rule['purpose_lvl4']))

    matched_df = matched if matched_df is None else matched_df.unionByName(matched)


from pyspark.sql.window import Window
from pyspark.sql.functions import row_number

window = Window.partitionBy("transaction_id").orderBy("rule_id")  # or use custom priority
final_matched = matched_df.withColumn("rn", row_number().over(window)).filter("rn = 1")


result = transactions_df.join(
    final_matched.select("transaction_id", "purpose_lvl1", "purpose_lvl2", "purpose_lvl3", "purpose_lvl4"),
    on="transaction_id",
    how="left"
)